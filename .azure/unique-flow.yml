parameters:
  - name: api_inputs
    displayName: Inputs from API (json)
    type: string
  - name: config
    displayName: Inputs from user workflow (json)
    type: string


steps:
- bash: |
    execution_id=$(echo '${{ parameters.api_inputs }}' | jq -cr '.execution_id')
    export HTTP_ENABLE_DEBUG=true

    curl -fo script.sh https://workflow-api.v1.stackspot.com/workflows/$execution_id --header 'Authorization: Bearer $(secret_stk_login)'
    exitcode=$?
    if [[ "$exitcode" -ne "0" ]]; then
        echo "------------------------------------------------------------------------------------------"
        echo "---------------------------------------- Debug Starting ----------------------------------"
        echo "------------------------------------------------------------------------------------------"

        curl -o debug.log https://workflow-api.v1.stackspot.com/workflows/$execution_id --header 'Authorization: Bearer $(secret_stk_login)'
        cat debug.log

        echo "------------------------------------------------------------------------------------------"
        echo "---------------------------------------- Debug Ending ------------------------------------"
        echo "------------------------------------------------------------------------------------------"
    else
        chmod +x script.sh

        echo "------------------------------------------------------------------------------------------"
        echo "---------------------------------------- Starting ----------------------------------------"
        echo "------------------------------------------------------------------------------------------"

        bash script.sh

        echo "------------------------------------------------------------------------------------------"
        echo "----------------------------------------  Ending  ----------------------------------------"
        echo "------------------------------------------------------------------------------------------"

    fi